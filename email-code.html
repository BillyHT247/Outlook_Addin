<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Email Code</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 12px;
      font-size: 13px;
    }
    label {
      display: block;
      margin-top: 8px;
      margin-bottom: 2px;
    }
    select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 12px;
      padding: 6px 10px;
    }
    #status {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h3>Email Code</h3>

  <label for="when">WHEN</label>
  <select id="when">
    <option value="">-- select --</option>
    <option>HP</option>
    <option>QH</option>
    <option>TWP</option>
    <option>TWM</option>
    <option>TWE</option>
    <option>NTW</option>
  </select>

  <label for="type">TYPE</label>
  <select id="type">
    <option value="">-- select --</option>
    <option>A</option>
    <option>I</option>
    <option>D</option>
    <option>Q</option>
    <option>R</option>
  </select>

  <label for="time">TIME</label>
  <select id="time">
    <option value="">-- select --</option>
    <option>1m</option>
    <option>3m</option>
    <option>5m</option>
    <option>10m</option>
    <option>15m</option>
    <option>30m</option>
    <option>60m</option>
    <option>1+h</option>
  </select>

  <button id="apply">Apply to subject and BCC</button>

  <div id="status"></div>

  <script>
    const LOG_ADDRESS =
      "email-log-appsRuWy6BC5D4NuW.2aca-wtrgt8WWx3ZdCuIaY.2a98@automations.airtableemail.com";

    Office.onReady(function () {
      const btn = document.getElementById("apply");
      if (btn) {
        btn.addEventListener("click", applyCode);
      }
    });

    function applyCode() {
      const whenCode = document.getElementById("when").value;
      const typeCode = document.getElementById("type").value;
      const timeCode = document.getElementById("time").value;

      if (!whenCode || !typeCode || !timeCode) {
        showStatus("Please select WHEN, TYPE, and TIME.");
        return;
      }

      const item = Office.context.mailbox.item;
      if (!item || !item.subject || !item.bcc) {
        showStatus("This add-in only works when composing a message.");
        return;
      }

      const prefix = whenCode + " - " + typeCode + " - " + timeCode + " - ";

      // 1) Update subject
      item.subject.getAsync(function (subResult) {
        if (subResult.status !== Office.AsyncResultStatus.Succeeded) {
          showStatus("Could not read subject.");
          return;
        }

        const current = subResult.value || "";

        // Strip any existing code prefix to avoid stacking
        const stripped = current.replace(
          /^(HP|QH|TWP|TWM|TWE|NTW) - (A|I|D|Q|R) - (1m|3m|5m|10m|15m|30m|60m|1\+h) - /,
          ""
        );

        item.subject.setAsync(prefix + stripped, function (setSubResult) {
          if (setSubResult.status !== Office.AsyncResultStatus.Succeeded) {
            showStatus("Could not set subject.");
            return;
          }

          // 2) Ensure the logging BCC address is present
          ensureLoggingBcc(item, function (ok) {
            if (ok) {
              showStatus("Email code applied.");
            } else {
              showStatus("Email code applied, but BCC could not be updated.");
            }
          });
        });
      });
    }

    function ensureLoggingBcc(item, callback) {
      item.bcc.getAsync(function (bccResult) {
        if (bccResult.status !== Office.AsyncResultStatus.Succeeded) {
          callback(false);
          return;
        }

        let recipients = bccResult.value || [];

        const exists = recipients.some(function (r) {
          return (
            r &&
            r.emailAddress &&
            r.emailAddress.toLowerCase() === LOG_ADDRESS.toLowerCase()
          );
        });

        if (exists) {
          callback(true);
          return;
        }

        recipients = recipients.slice(); // copy
        recipients.push({ emailAddress: LOG_ADDRESS, displayName: "" });

        item.bcc.setAsync(recipients, function (setResult) {
          callback(setResult.status === Office.AsyncResultStatus.Succeeded);
        });
      });
    }

    function showStatus(msg) {
      const el = document.getElementById("status");
      if (el) {
        el.textContent = msg;
      }
    }
  </script>
</body>
</html>
